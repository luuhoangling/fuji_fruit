{% extends "base.html" %}

{% block title %}Sản phẩm - Fuji Store{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('public.index') }}">Trang chủ</a></li>
            <li class="breadcrumb-item active" aria-current="page">Sản phẩm</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">Sản phẩm</h1>
            <p class="text-muted">Khám phá các sản phẩm chất lượng tại Fuji Store</p>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Bộ lọc</h5>
                </div>
                <div class="card-body">
                    <!-- Search -->
                    <div class="mb-3">
                        <label for="searchFilter" class="form-label">Tìm kiếm</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Tìm sản phẩm...">
                    </div>

                    <!-- Categories -->
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <div id="categoriesFilter">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Brands -->
                    <div class="mb-3">
                        <label class="form-label">Thương hiệu</label>
                        <div id="brandsFilter">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Buttons -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="applyFilters()">Áp dụng</button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">Xóa bộ lọc</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Area -->
        <div class="col-lg-9">
            <!-- Sort and View Options -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <label for="sortSelect" class="form-label me-2 mb-0">Sắp xếp:</label>
                        <select class="form-select" id="sortSelect" onchange="applyFilters()" style="width: auto;">
                            <option value="created_at">Mới nhất</option>
                            <option value="name">Tên A-Z</option>
                            <option value="name_desc">Tên Z-A</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group" aria-label="View options">
                        <button type="button" class="btn btn-outline-secondary active" onclick="setViewMode('grid')">
                            <i class="bi bi-grid"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="setViewMode('list')">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Products Container -->
            <div id="productsContainer">
                <div class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <nav aria-label="Products pagination" id="paginationContainer" style="display: none;">
                <ul class="pagination justify-content-center" id="pagination">
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Product Detail Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productModalContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFilters = {
    page: 1,
    per_page: 12,
    sort: 'created_at',
    category: '',
    brand: '',
    q: ''
};

let viewMode = 'grid';

document.addEventListener('DOMContentLoaded', function() {
    // Get URL params
    const urlParams = new URLSearchParams(window.location.search);
    currentFilters.q = urlParams.get('q') || '';
    currentFilters.category = urlParams.get('category') || '';
    currentFilters.brand = urlParams.get('brand') || '';
    
    // Set form values
    document.getElementById('searchFilter').value = currentFilters.q;
    
    // Load data
    loadCategories();
    loadBrands();
    loadProducts();
});

async function loadCategories() {
    try {
        const response = await fetch('/api/categories');
        const data = await response.json();
        
        if (response.ok) {
            renderCategoriesFilter(data.categories);
        }
    } catch (error) {
        console.error('Failed to load categories:', error);
    }
}

function renderCategoriesFilter(categories) {
    const container = document.getElementById('categoriesFilter');
    let html = '';
    
    // Add "All" option
    html += `
        <div class="form-check">
            <input class="form-check-input" type="radio" name="categoryFilter" value="" id="categoryAll" ${!currentFilters.category ? 'checked' : ''}>
            <label class="form-check-label" for="categoryAll">Tất cả</label>
        </div>
    `;
    
    categories.forEach(category => {
        html += `
            <div class="form-check">
                <input class="form-check-input" type="radio" name="categoryFilter" value="${category.id}" id="category${category.id}" ${currentFilters.category === category.id ? 'checked' : ''}>
                <label class="form-check-label" for="category${category.id}">${category.name}</label>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function loadBrands() {
    try {
        const response = await fetch('/api/brands');
        const data = await response.json();
        
        if (response.ok) {
            renderBrandsFilter(data.brands);
        }
    } catch (error) {
        console.error('Failed to load brands:', error);
    }
}

function renderBrandsFilter(brands) {
    const container = document.getElementById('brandsFilter');
    let html = '';
    
    // Add "All" option
    html += `
        <div class="form-check">
            <input class="form-check-input" type="radio" name="brandFilter" value="" id="brandAll" ${!currentFilters.brand ? 'checked' : ''}>
            <label class="form-check-label" for="brandAll">Tất cả</label>
        </div>
    `;
    
    brands.forEach(brand => {
        html += `
            <div class="form-check">
                <input class="form-check-input" type="radio" name="brandFilter" value="${brand.id}" id="brand${brand.id}" ${currentFilters.brand === brand.id ? 'checked' : ''}>
                <label class="form-check-label" for="brand${brand.id}">${brand.name}</label>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function loadProducts() {
    try {
        const params = new URLSearchParams(currentFilters);
        const response = await fetch(`/api/products?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            renderProducts(data.products);
            renderPagination(data.pagination);
        } else {
            document.getElementById('productsContainer').innerHTML = `
                <div class="alert alert-warning">Không thể tải sản phẩm</div>
            `;
        }
    } catch (error) {
        document.getElementById('productsContainer').innerHTML = `
            <div class="alert alert-danger">Đã xảy ra lỗi</div>
        `;
    }
}

function renderProducts(products) {
    const container = document.getElementById('productsContainer');
    
    if (!products || products.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-search fs-1 text-muted"></i>
                <p class="mt-3">Không tìm thấy sản phẩm nào</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    if (viewMode === 'grid') {
        html = '<div class="row">';
        products.forEach(product => {
            html += `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <img src="${product.image_url || '/static/images/no-image.png'}" 
                             class="card-img-top" alt="${product.name}" style="height: 250px; object-fit: cover; cursor: pointer;"
                             onclick="showProductDetail('${product.slug}')">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">${product.name}</h6>
                            <p class="card-text text-muted small">${product.short_desc}</p>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-primary fw-bold">${product.price.toLocaleString('vi-VN')} VNĐ</span>
                                    <small class="text-muted">Còn: ${product.available}</small>
                                </div>
                                <button class="btn btn-primary btn-sm w-100" 
                                        onclick="addToCart('${product.variant_id}', 1)"
                                        ${product.available <= 0 ? 'disabled' : ''}>
                                    ${product.available <= 0 ? 'Hết hàng' : 'Thêm vào giỏ'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    } else {
        // List view
        products.forEach(product => {
            html += `
                <div class="card mb-3">
                    <div class="row g-0">
                        <div class="col-md-3">
                            <img src="${product.image_url || '/static/images/no-image.png'}" 
                                 class="img-fluid rounded-start h-100" alt="${product.name}" style="object-fit: cover; cursor: pointer;"
                                 onclick="showProductDetail('${product.slug}')">
                        </div>
                        <div class="col-md-9">
                            <div class="card-body h-100 d-flex flex-column">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text">${product.short_desc}</p>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="text-primary fw-bold fs-5">${product.price.toLocaleString('vi-VN')} VNĐ</span>
                                            <small class="text-muted ms-2">Còn: ${product.available}</small>
                                        </div>
                                        <button class="btn btn-primary" 
                                                onclick="addToCart('${product.variant_id}', 1)"
                                                ${product.available <= 0 ? 'disabled' : ''}>
                                            ${product.available <= 0 ? 'Hết hàng' : 'Thêm vào giỏ'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    container.innerHTML = html;
}

function renderPagination(pagination) {
    const container = document.getElementById('paginationContainer');
    const paginationList = document.getElementById('pagination');
    
    if (pagination.pages <= 1) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    
    let html = '';
    
    // Previous button
    html += `
        <li class="page-item ${pagination.page <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${pagination.page - 1})">Trước</a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= pagination.pages; i++) {
        if (i === pagination.page || 
            i === 1 || 
            i === pagination.pages || 
            (i >= pagination.page - 2 && i <= pagination.page + 2)) {
            html += `
                <li class="page-item ${i === pagination.page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === pagination.page - 3 || i === pagination.page + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Next button
    html += `
        <li class="page-item ${pagination.page >= pagination.pages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${pagination.page + 1})">Sau</a>
        </li>
    `;
    
    paginationList.innerHTML = html;
}

function applyFilters() {
    // Get form values
    currentFilters.q = document.getElementById('searchFilter').value.trim();
    currentFilters.sort = document.getElementById('sortSelect').value;
    
    // Get selected category
    const categoryRadio = document.querySelector('input[name="categoryFilter"]:checked');
    currentFilters.category = categoryRadio ? categoryRadio.value : '';
    
    // Get selected brand
    const brandRadio = document.querySelector('input[name="brandFilter"]:checked');
    currentFilters.brand = brandRadio ? brandRadio.value : '';
    
    // Reset to first page
    currentFilters.page = 1;
    
    // Update URL
    const params = new URLSearchParams();
    if (currentFilters.q) params.set('q', currentFilters.q);
    if (currentFilters.category) params.set('category', currentFilters.category);
    if (currentFilters.brand) params.set('brand', currentFilters.brand);
    
    const newUrl = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
    window.history.pushState({}, '', newUrl);
    
    // Load products
    loadProducts();
}

function clearFilters() {
    currentFilters = {
        page: 1,
        per_page: 12,
        sort: 'created_at',
        category: '',
        brand: '',
        q: ''
    };
    
    // Reset form
    document.getElementById('searchFilter').value = '';
    document.getElementById('sortSelect').value = 'created_at';
    document.querySelector('input[name="categoryFilter"][value=""]').checked = true;
    document.querySelector('input[name="brandFilter"][value=""]').checked = true;
    
    // Update URL
    window.history.pushState({}, '', window.location.pathname);
    
    // Load products
    loadProducts();
}

function changePage(page) {
    currentFilters.page = page;
    loadProducts();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function setViewMode(mode) {
    viewMode = mode;
    
    // Update button states
    document.querySelectorAll('[onclick^="setViewMode"]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[onclick="setViewMode('${mode}')"]`).classList.add('active');
    
    // Re-render products
    loadProducts();
}

async function showProductDetail(slug) {
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
    
    try {
        const response = await fetch(`/api/products/${slug}`);
        const data = await response.json();
        
        if (response.ok) {
            renderProductModal(data.product);
        } else {
            document.getElementById('productModalContent').innerHTML = `
                <div class="alert alert-warning">Không thể tải thông tin sản phẩm</div>
            `;
        }
    } catch (error) {
        document.getElementById('productModalContent').innerHTML = `
            <div class="alert alert-danger">Đã xảy ra lỗi</div>
        `;
    }
}

function renderProductModal(product) {
    const container = document.getElementById('productModalContent');
    
    let imagesHtml = '';
    if (product.images && product.images.length > 0) {
        imagesHtml = `
            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    ${product.images.map((image, index) => `
                        <div class="carousel-item ${index === 0 ? 'active' : ''}">
                            <img src="${image.url}" class="d-block w-100" alt="${image.alt_text}" style="height: 300px; object-fit: cover;">
                        </div>
                    `).join('')}
                </div>
                ${product.images.length > 1 ? `
                    <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                ` : ''}
            </div>
        `;
    } else {
        imagesHtml = `<img src="/static/images/no-image.png" class="img-fluid" alt="${product.name}">`;
    }
    
    let variantsHtml = '';
    if (product.variants && product.variants.length > 1) {
        variantsHtml = `
            <div class="mb-3">
                <label class="form-label">Chọn biến thể:</label>
                <select class="form-select" id="variantSelect" onchange="updateVariantInfo()">
                    ${product.variants.map(variant => `
                        <option value="${variant.id}" data-price="${variant.list_price}" data-available="${variant.available}">
                            ${variant.name} - ${variant.list_price.toLocaleString('vi-VN')} VNĐ
                        </option>
                    `).join('')}
                </select>
            </div>
        `;
    }
    
    const defaultVariant = product.variants[0];
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                ${imagesHtml}
            </div>
            <div class="col-md-6">
                <h4>${product.name}</h4>
                <p class="text-muted">${product.short_desc}</p>
                
                ${variantsHtml}
                
                <div class="mb-3">
                    <span class="h4 text-primary" id="productPrice">${defaultVariant.list_price.toLocaleString('vi-VN')} VNĐ</span>
                    <br>
                    <small class="text-muted">Còn lại: <span id="productAvailable">${defaultVariant.available}</span></small>
                </div>
                
                <div class="mb-3">
                    <label for="quantity" class="form-label">Số lượng:</label>
                    <input type="number" class="form-control" id="quantity" value="1" min="1" max="${defaultVariant.available}">
                </div>
                
                <button class="btn btn-primary btn-lg w-100" onclick="addToCartFromModal()" id="addToCartBtn" ${defaultVariant.available <= 0 ? 'disabled' : ''}>
                    ${defaultVariant.available <= 0 ? 'Hết hàng' : 'Thêm vào giỏ hàng'}
                </button>
                
                ${product.description ? `
                    <div class="mt-4">
                        <h6>Mô tả sản phẩm:</h6>
                        <p>${product.description}</p>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function updateVariantInfo() {
    const select = document.getElementById('variantSelect');
    const option = select.selectedOptions[0];
    const price = parseInt(option.dataset.price);
    const available = parseInt(option.dataset.available);
    
    document.getElementById('productPrice').textContent = price.toLocaleString('vi-VN') + ' VNĐ';
    document.getElementById('productAvailable').textContent = available;
    
    const quantityInput = document.getElementById('quantity');
    quantityInput.max = available;
    if (parseInt(quantityInput.value) > available) {
        quantityInput.value = available;
    }
    
    const addToCartBtn = document.getElementById('addToCartBtn');
    if (available <= 0) {
        addToCartBtn.disabled = true;
        addToCartBtn.textContent = 'Hết hàng';
    } else {
        addToCartBtn.disabled = false;
        addToCartBtn.textContent = 'Thêm vào giỏ hàng';
    }
}

function addToCartFromModal() {
    const variantSelect = document.getElementById('variantSelect');
    const variantId = variantSelect ? variantSelect.value : document.querySelector('[data-variant-id]').dataset.variantId;
    const quantity = parseInt(document.getElementById('quantity').value);
    
    addToCart(variantId, quantity);
}

async function addToCart(variantId, qty) {
    try {
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
        }
        
        const response = await fetch('/api/cart/items', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                variant_id: variantId,
                qty: qty
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('Đã thêm vào giỏ hàng!', 'success');
            loadCart(); // Refresh cart badge
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Đã xảy ra lỗi', 'danger');
    }
}
</script>
{% endblock %}