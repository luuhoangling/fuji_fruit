{% extends "admin/base.html" %}

{% block page_title %}{{ 'Chỉnh sửa phí ship' if shipping_rate else 'Thêm phí ship mới' }}{% endblock %}
{% block page_subtitle %}{{ 'Cập nhật thông tin phí ship' if shipping_rate else 'Thiết lập phí vận chuyển theo khu vực' }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card table-custom">
            <div class="card-header">
                <h5 class="card-title mb-0 text-white">
                    <i class="fas fa-truck"></i> {{ 'Chỉnh sửa phí ship' if shipping_rate else 'Thêm phí ship mới' }}
                </h5>
            </div>
            <div class="card-body">
                <form id="shippingRateForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="name" class="form-label">Tên phí ship *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ shipping_rate.name if shipping_rate else '' }}" 
                                       placeholder="VD: Nội thành Hà Nội - Giao hàng tiêu chuẩn" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="shipping_method" class="form-label">Phương thức giao hàng</label>
                                <select class="form-select" id="shipping_method" name="shipping_method">
                                    <option value="standard" {{ 'selected' if shipping_rate and shipping_rate.shipping_method == 'standard' else '' }}>Tiêu chuẩn</option>
                                    <option value="express" {{ 'selected' if shipping_rate and shipping_rate.shipping_method == 'express' else '' }}>Nhanh</option>
                                    <option value="overnight" {{ 'selected' if shipping_rate and shipping_rate.shipping_method == 'overnight' else '' }}>Hỏa tốc</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="3" placeholder="Mô tả chi tiết về phương thức giao hàng">{{ shipping_rate.description if shipping_rate else '' }}</textarea>
                    </div>
                    
                    <div class="card bg-light mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Phạm vi áp dụng</h6>
                            <small class="text-muted">Để trống để áp dụng cho toàn quốc</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="province" class="form-label">Tỉnh/Thành phố</label>
                                        <input type="text" class="form-control" id="province" name="province" 
                                               value="{{ shipping_rate.province if shipping_rate else '' }}" 
                                               placeholder="VD: Hà Nội">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="district" class="form-label">Quận/Huyện</label>
                                        <input type="text" class="form-control" id="district" name="district" 
                                               value="{{ shipping_rate.district if shipping_rate else '' }}" 
                                               placeholder="VD: Ba Đình">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="ward" class="form-label">Phường/Xã</label>
                                        <input type="text" class="form-control" id="ward" name="ward" 
                                               value="{{ shipping_rate.ward if shipping_rate else '' }}" 
                                               placeholder="VD: Cống Vị">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card bg-light mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Cấu hình phí</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="base_fee" class="form-label">Phí cơ bản *</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="base_fee" name="base_fee" 
                                                   value="{{ shipping_rate.base_fee if shipping_rate else '' }}" 
                                                   min="0" step="1000" required>
                                            <span class="input-group-text">VNĐ</span>
                                        </div>
                                        <div class="form-text">Phí vận chuyển cơ bản</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="per_kg_fee" class="form-label">Phí theo trọng lượng</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="per_kg_fee" name="per_kg_fee" 
                                                   value="{{ shipping_rate.per_kg_fee if shipping_rate else '0' }}" 
                                                   min="0" step="1000">
                                            <span class="input-group-text">VNĐ/kg</span>
                                        </div>
                                        <div class="form-text">Phí thêm cho mỗi kg</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="free_shipping_threshold" class="form-label">Miễn phí ship từ</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="free_shipping_threshold" name="free_shipping_threshold" 
                                           value="{{ shipping_rate.free_shipping_threshold if shipping_rate else '' }}" 
                                           min="0" step="10000">
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                                <div class="form-text">Đơn hàng có giá trị từ số tiền này sẽ được miễn phí ship</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card bg-light mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Thời gian giao hàng</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="estimated_days_min" class="form-label">Thời gian tối thiểu *</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="estimated_days_min" name="estimated_days_min" 
                                                   value="{{ shipping_rate.estimated_days_min if shipping_rate else '1' }}" 
                                                   min="1" max="30" required>
                                            <span class="input-group-text">ngày</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="estimated_days_max" class="form-label">Thời gian tối đa *</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="estimated_days_max" name="estimated_days_max" 
                                                   value="{{ shipping_rate.estimated_days_max if shipping_rate else '3' }}" 
                                                   min="1" max="30" required>
                                            <span class="input-group-text">ngày</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Độ ưu tiên</label>
                                <input type="number" class="form-control" id="priority" name="priority" 
                                       value="{{ shipping_rate.priority if shipping_rate else '0' }}" 
                                       min="0" max="100">
                                <div class="form-text">Số càng cao, ưu tiên càng cao (0-100)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                           {{ 'checked' if not shipping_rate or shipping_rate.is_active else '' }}>
                                    <label class="form-check-label" for="is_active">
                                        Kích hoạt phí ship này
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('admin.shipping_rates') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>
                        <button type="submit" class="btn btn-custom">
                            <i class="fas fa-save"></i> {{ 'Cập nhật' if shipping_rate else 'Tạo phí ship' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('shippingRateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    // Convert form data to object
    for (let [key, value] of formData.entries()) {
        if (key === 'is_active') {
            data[key] = true;
        } else if (value !== '') {
            data[key] = value;
        }
    }
    
    // Handle checkbox manually since it won't be in FormData if unchecked
    if (!document.getElementById('is_active').checked) {
        data['is_active'] = false;
    }
    
    // Validate time estimates
    const minDays = parseInt(data.estimated_days_min);
    const maxDays = parseInt(data.estimated_days_max);
    
    if (maxDays < minDays) {
        alert('Thời gian giao hàng tối đa phải lớn hơn hoặc bằng thời gian tối thiểu');
        return;
    }
    
    const url = '{{ url_for("admin.create_shipping_rate") }}';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Phí ship đã được tạo thành công!');
            window.location.href = '{{ url_for("admin.shipping_rates") }}';
        } else {
            alert('Lỗi: ' + data.message);
        }
    })
    .catch(error => {
        alert('Có lỗi xảy ra: ' + error);
    });
});
</script>
{% endblock %}