{% extends "base.html" %}

{% block title %}Giỏ hàng - Fuji Fruit{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('site.home') }}">Trang chủ</a></li>
            <li class="breadcrumb-item active">Giỏ hàng</li>
        </ol>
    </nav>

    <h1>Giỏ hàng của bạn</h1>

    {% if items %}
    <div class="row">
        <!-- Cart Items -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th>Đơn giá</th>
                                    <th>Số lượng</th>
                                    <th>Thành tiền</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cartItems">
                                {% for item in items %}
                                <tr data-product-id="{{ item.product_id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ item.image_url or '/static/img/no-image.jpg' }}" 
                                                 class="img-thumbnail me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                            <div>
                                                <h6 class="mb-0">
                                                    <a href="{{ url_for('site.product_detail', slug=item.slug) }}" 
                                                       class="text-decoration-none">{{ item.name }}</a>
                                                </h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <span class="unit-price">{{ item.unit_price | vnd }}</span>
                                    </td>
                                    <td class="align-middle">
                                        <div class="qty-controls d-flex align-items-center">
                                            <button class="btn btn-sm btn-outline-secondary qty-decrease" type="button">-</button>
                                            <input type="number" class="form-control form-control-sm mx-2 qty-input" 
                                                   value="{{ item.qty }}" min="1" max="99" style="width: 60px;">
                                            <button class="btn btn-sm btn-outline-secondary qty-increase" type="button">+</button>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <span class="line-total fw-bold">{{ item.line_total | vnd }}</span>
                                    </td>
                                    <td class="align-middle">
                                        <button class="btn btn-sm btn-outline-danger remove-item" type="button">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <a href="{{ url_for('site.home') }}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left"></i> Tiếp tục mua sắm
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Summary -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Tổng kết đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Tạm tính:</span>
                        <span id="subtotal" class="fw-bold">{{ subtotal | vnd }}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-3 text-muted">
                        <small>Phí vận chuyển:</small>
                        <small>Tính khi thanh toán</small>
                    </div>
                    
                    <hr>
                    
                    <div class="d-grid">
                        <a href="{{ url_for('site.checkout') }}" class="btn btn-primary btn-lg">
                            <i class="bi bi-credit-card"></i> Thanh toán
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Empty Cart -->
    <div class="text-center py-5">
        <i class="bi bi-cart-x display-1 text-muted"></i>
        <h3 class="mt-3">Giỏ hàng trống</h3>
        <p class="text-muted">Bạn chưa có sản phẩm nào trong giỏ hàng</p>
        <a href="{{ url_for('site.home') }}" class="btn btn-primary">
            Bắt đầu mua sắm
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cartItems = document.getElementById('cartItems');
    const subtotalElement = document.getElementById('subtotal');
    
    // Quantity controls
    cartItems.addEventListener('click', function(e) {
        const target = e.target;
        const row = target.closest('tr');
        const qtyInput = row.querySelector('.qty-input');
        
        if (target.classList.contains('qty-decrease')) {
            const currentQty = parseInt(qtyInput.value);
            if (currentQty > 1) {
                const newQty = currentQty - 1;
                qtyInput.value = newQty;
                updateLineTotal(row);
                updateCartOnServer(row.dataset.productId, newQty);
            }
        } else if (target.classList.contains('qty-increase')) {
            const currentQty = parseInt(qtyInput.value);
            if (currentQty < 99) {
                const newQty = currentQty + 1;
                qtyInput.value = newQty;
                updateLineTotal(row);
                updateCartOnServer(row.dataset.productId, newQty);
            }
        } else if (target.classList.contains('remove-item') || target.closest('.remove-item')) {
            const productId = row.dataset.productId;
            if (confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                // Send update request to remove item
                fetch('/cart/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ 
                        updates: { [productId]: 0 } 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the row from display
                        row.remove();
                        updateSubtotal();
                        
                        // Update cart count in navbar
                        const cartCountElements = document.querySelectorAll('.cart-count');
                        cartCountElements.forEach(el => {
                            el.textContent = data.cart_count;
                        });
                        
                        // Check if cart is empty
                        if (data.cart_count === 0) {
                            location.reload(); // Reload to show empty cart message
                        }
                    } else {
                        alert('Có lỗi xảy ra khi xóa sản phẩm');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra');
                });
            }
        }
    });
    
    // Quantity input change
    cartItems.addEventListener('change', function(e) {
        if (e.target.classList.contains('qty-input')) {
            const row = e.target.closest('tr');
            const newQty = parseInt(e.target.value);
            updateLineTotal(row);
            updateCartOnServer(row.dataset.productId, newQty);
        }
    });
    
    function updateLineTotal(row) {
        const qtyInput = row.querySelector('.qty-input');
        const unitPriceText = row.querySelector('.unit-price').textContent;
        const lineTotalElement = row.querySelector('.line-total');
        
        const qty = parseInt(qtyInput.value);
        const unitPrice = parseFloat(unitPriceText.replace(/[^\d]/g, ''));
        const lineTotal = qty * unitPrice;
        
        lineTotalElement.textContent = new Intl.NumberFormat('vi-VN').format(lineTotal) + '₫';
        
        updateSubtotal();
    }
    
    function updateSubtotal() {
        let total = 0;
        const lineTotals = document.querySelectorAll('.line-total');
        
        lineTotals.forEach(element => {
            const amount = parseFloat(element.textContent.replace(/[^\d]/g, ''));
            total += amount;
        });
        
        subtotalElement.textContent = new Intl.NumberFormat('vi-VN').format(total) + '₫';
    }
    
    function updateCartOnServer(productId, qty) {
        fetch('/cart/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ 
                updates: { [productId]: qty } 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update cart count in navbar
                const cartCountElements = document.querySelectorAll('.cart-count');
                cartCountElements.forEach(el => {
                    el.textContent = data.cart_count;
                });
            }
        })
        .catch(error => {
            console.error('Error updating cart:', error);
        });
    }
});
</script>
{% endblock %}