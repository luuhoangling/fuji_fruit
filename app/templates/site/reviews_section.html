<div class="reviews-section">
    <h3>Đánh giá sản phẩm</h3>
    
    <!-- Reviews Summary -->
    {% if product.rating %}
    <div class="reviews-summary p-3 bg-light rounded mb-4">
        <div class="row">
            <div class="col-md-6">
                <div class="text-center">
                    <div class="h2 text-primary mb-1">{{ "%.1f" | format(product.rating.avg or 0) }}</div>
                    {% include '_partials/rating_stars.html' %}
                    <div class="text-muted mt-1">{{ product.rating.count or 0 }} đánh giá</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Review Form -->
    {% if current_user %}
    <div class="review-form mb-4">
        <h5>Viết đánh giá</h5>
        <form method="POST" action="{{ url_for('site.submit_review', slug=product.slug) }}">
            {{ review_form.hidden_tag() }}
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ review_form.user_name.label(class="form-label") }}
                    {{ review_form.user_name(class="form-control", value=current_user.display_name) }}
                </div>
                
                <div class="col-md-6 mb-3">
                    {{ review_form.rating.label(class="form-label") }}
                    <div class="rating-input">
                        <input type="radio" name="rating" value="1" id="star1" required>
                        <label for="star1" class="star-label" data-rating="1">
                            <i class="bi bi-star"></i>
                        </label>
                        <input type="radio" name="rating" value="2" id="star2" required>
                        <label for="star2" class="star-label" data-rating="2">
                            <i class="bi bi-star"></i>
                        </label>
                        <input type="radio" name="rating" value="3" id="star3" required>
                        <label for="star3" class="star-label" data-rating="3">
                            <i class="bi bi-star"></i>
                        </label>
                        <input type="radio" name="rating" value="4" id="star4" required>
                        <label for="star4" class="star-label" data-rating="4">
                            <i class="bi bi-star"></i>
                        </label>
                        <input type="radio" name="rating" value="5" id="star5" required>
                        <label for="star5" class="star-label" data-rating="5">
                            <i class="bi bi-star"></i>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                {{ review_form.content.label(class="form-label") }}
                {{ review_form.content(class="form-control") }}
            </div>
            
            <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
        </form>
    </div>
    {% else %}
    <div class="review-form mb-4">
        <div class="alert alert-info">
            <h5><i class="bi bi-info-circle"></i> Đăng nhập để đánh giá</h5>
            <p class="mb-2">Bạn cần đăng nhập để có thể viết đánh giá về sản phẩm này.</p>
            <a href="{{ url_for('site.login') }}" class="btn btn-primary btn-sm">Đăng nhập</a>
            <a href="{{ url_for('site.register') }}" class="btn btn-outline-primary btn-sm">Đăng ký</a>
        </div>
    </div>
    {% endif %}

    <!-- Reviews List -->
    <div class="reviews-list">
        <h5>Các đánh giá khác ({{ reviews.total }} đánh giá)</h5>
        
        {% if reviews.items %}
            {% for review in reviews.items %}
            <div class="review-item border-bottom py-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <strong>{{ review.user_name or 'Khách hàng' }}</strong>
                        <div class="rating-display">
                            {% for i in range(1, 6) %}
                                {% if i <= review.rating %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                {% else %}
                                    <i class="bi bi-star text-muted"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <small class="text-muted">{{ review.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                </div>
                <p class="mb-0">{{ review.content }}</p>
            </div>
            {% endfor %}
            
            <!-- Reviews Pagination -->
            {% if reviews.total > 10 %}
            <div class="mt-4">
                {% set page = request.args.get('page', 1, type=int) %}
                {% set page_size = 10 %}
                {% set total = reviews.total %}
                {% include '_partials/pagination.html' %}
            </div>
            {% endif %}
        {% else %}
            <div class="text-center text-muted py-4">
                <p>Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá sản phẩm này!</p>
            </div>
        {% endif %}
    </div>
</div>

<style>
.rating-input {
    display: flex;
    gap: 5px;
}

.rating-input input[type="radio"] {
    display: none;
}

.rating-input .star-label {
    color: #ddd;
    font-size: 1.2em;
    cursor: pointer;
    transition: color 0.2s;
}

.rating-input .star-label:hover {
    color: #ffc107;
}

.rating-input .star-label.active {
    color: #ffc107;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const starLabels = document.querySelectorAll('.rating-input .star-label');
    const ratingContainer = document.querySelector('.rating-input');
    
    if (!ratingContainer) return;
    
    // Handle star click
    starLabels.forEach(function(label) {
        label.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            const radioInput = document.getElementById('star' + rating);
            radioInput.checked = true;
            updateStarsDisplay(rating);
        });
        
        // Handle hover
        label.addEventListener('mouseenter', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            updateStarsDisplay(rating);
        });
    });
    
    // Handle mouse leave to reset to selected state
    ratingContainer.addEventListener('mouseleave', function() {
        const checkedInput = document.querySelector('.rating-input input[type="radio"]:checked');
        if (checkedInput) {
            const rating = parseInt(checkedInput.value);
            updateStarsDisplay(rating);
        } else {
            updateStarsDisplay(0);
        }
    });
    
    function updateStarsDisplay(rating) {
        starLabels.forEach(function(label) {
            const labelRating = parseInt(label.getAttribute('data-rating'));
            if (labelRating <= rating) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        });
    }
});
</script>