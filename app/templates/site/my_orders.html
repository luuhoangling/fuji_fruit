{% extends "base.html" %}

{% block title %}Đơn hàng của tôi - Fuji Fruit{% endblock %}

{# Import order helpers for consistent status display #}
{% from 'site/_order_helpers.html' import render_user_order_status, render_user_payment_status, render_user_payment_method, render_user_actions %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('site.home') }}">Trang chủ</a></li>
            <li class="breadcrumb-item active">Đơn hàng của tôi</li>
        </ol>
    </nav>

    <h1>Đơn hàng của tôi</h1>

    <!-- Status Filter Tabs -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link {% if current_status == 'all' %}active{% endif %}" 
               href="{{ url_for('site.my_orders', status='all') }}">
                Tất cả đơn hàng
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if current_status == 'pending' %}active{% endif %}" 
               href="{{ url_for('site.my_orders', status='pending') }}">
                Đang chờ xử lý
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if current_status == 'waiting_admin_confirmation' %}active{% endif %}" 
               href="{{ url_for('site.my_orders', status='waiting_admin_confirmation') }}">
                Chờ xác nhận
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if current_status == 'confirmed' %}active{% endif %}" 
               href="{{ url_for('site.my_orders', status='confirmed') }}">
                Đã xác nhận
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if current_status == 'fulfilled' %}active{% endif %}" 
               href="{{ url_for('site.my_orders', status='fulfilled') }}">
                Đang giao hàng
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if current_status == 'completed' %}active{% endif %}" 
               href="{{ url_for('site.my_orders', status='completed') }}">
                Đã giao hàng
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if current_status == 'cancelled' %}active{% endif %}" 
               href="{{ url_for('site.my_orders', status='cancelled') }}">
                Đã hủy
            </a>
        </li>
    </ul>

    {% if orders %}
        <!-- Orders List -->
        <div class="row">
            {% for order in orders %}
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">
                                <a href="{{ url_for('site.order_detail', order_code=order.order_code) }}" 
                                   class="text-decoration-none">
                                    Đơn hàng #{{ order.order_code }}
                                </a>
                            </h6>
                            <small class="text-muted">
                                Đặt ngày: {{ order.created_at.strftime('%d/%m/%Y %H:%M') if order.created_at }}
                            </small>
                        </div>
                        <div class="text-end">
                            {{ render_user_order_status(order) }}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <strong>Khách hàng:</strong> {{ order.customer_name }}<br>
                                        <strong>Điện thoại:</strong> {{ order.phone }}
                                    </div>
                                    <div class="col-sm-6">
                                        <strong>Địa chỉ:</strong> {{ order.address[:50] }}{% if order.address|length > 50 %}...{% endif %}
                                    </div>
                                </div>
                                
                                <!-- Order Items Summary -->
                                <div class="mt-2">
                                    <strong>Sản phẩm:</strong>
                                    {% if order.items|length <= 2 %}
                                        {% for item in order.items %}
                                            {{ item.product_name }} (x{{ item.qty }}){% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {{ order.items[0].product_name }} (x{{ order.items[0].qty }}) và {{ order.items|length - 1 }} sản phẩm khác
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-2">
                                    <h5 class="mb-0">{{ "{:,.0f}".format(order.grand_total) }} đ</h5>
                                    {{ render_user_payment_status(order) }}
                                </div>
                                
                                <!-- Action Buttons -->
                                {{ render_user_actions(order) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav aria-label="Order pagination">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('site.my_orders', status=current_status, page=page-1) }}">Trước</a>
                    </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                        <li class="page-item active">
                            <span class="page-link">{{ p }}</span>
                        </li>
                    {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('site.my_orders', status=current_status, page=p) }}">{{ p }}</a>
                        </li>
                    {% elif p == 4 or p == total_pages - 3 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('site.my_orders', status=current_status, page=page+1) }}">Sau</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    {% else %}
        <!-- Empty State -->
        <div class="text-center py-5">
            <i class="bi bi-box-seam" style="font-size: 4rem; color: #6c757d;"></i>
            <h4 class="mt-3 text-muted">Chưa có đơn hàng nào</h4>
            <p class="text-muted">
                {% if current_status == 'all' %}
                    Bạn chưa có đơn hàng nào. Hãy bắt đầu mua sắm!
                {% elif current_status == 'pending' %}
                    Không có đơn hàng nào đang chờ xử lý.
                {% elif current_status == 'waiting_admin_confirmation' %}
                    Không có đơn hàng nào đang chờ xác nhận.
                {% elif current_status == 'confirmed' %}
                    Không có đơn hàng nào đã được xác nhận.
                {% elif current_status == 'fulfilled' %}
                    Không có đơn hàng nào đang giao.
                {% elif current_status == 'completed' %}
                    Không có đơn hàng nào đã được giao.
                {% elif current_status == 'cancelled' %}
                    Không có đơn hàng nào đã bị hủy.
                {% endif %}
            </p>
            {% if current_status == 'all' %}
                <a href="{{ url_for('site.home') }}" class="btn btn-primary">
                    <i class="bi bi-cart"></i> Bắt đầu mua sắm
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Hủy đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="cancelOrderForm" method="POST">
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn hủy đơn hàng này không?</p>
                    <div class="mb-3">
                        <label for="cancelNote" class="form-label">Lý do hủy (tùy chọn):</label>
                        <textarea class="form-control" id="cancelNote" name="note" rows="3" 
                                  placeholder="Nhập lý do hủy đơn hàng..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-danger">Xác nhận hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showCancelModal(orderCode) {
    const form = document.getElementById('cancelOrderForm');
    form.action = `{{ url_for('site.cancel_order_view', order_code='ORDER_CODE') }}`.replace('ORDER_CODE', orderCode);
    
    const modal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
    modal.show();
}

function confirmReceived(orderCode) {
    if (confirm('Xác nhận bạn đã nhận được đơn hàng này? Đơn hàng sẽ được đánh dấu hoàn thành.')) {
        fetch(`/user/orders/${orderCode}/confirm-received`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showAlert('error', data.error || 'Có lỗi xảy ra');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Có lỗi xảy ra khi xác nhận đã nhận hàng');
        });
    }
}

function getCsrfToken() {
    // Get CSRF token from meta tag or cookie
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}